/* webfinger.js v2.4.1 | (c) 2012-2014 Nick Jennings | License: AGPL | https://github.com/silverbucket/webfinger.js */
"undefined"==typeof XMLHttpRequest&&(XMLHttpRequest=require("xmlhttprequest").XMLHttpRequest),function(e){function t(e){return e.toString=function(){return this.message},e}function r(e){if("string"!=typeof e)return!1;var t=e.split("://");return"https"===t[0]?!0:!1}function o(e){"object"!=typeof e&&(e={}),this.config={tls_only:"undefined"!=typeof e.tls_only?e.tls_only:!0,webfist_fallback:"undefined"!=typeof e.webfist_fallback?e.webfist_fallback:!1,uri_fallback:"undefined"!=typeof e.uri_fallback?e.uri_fallback:!1,request_timeout:"undefined"!=typeof e.request_timeout?e.request_timeout:1e4}}var n={"http://webfist.org/spec/rel":"webfist","http://webfinger.net/rel/avatar":"avatar",remotestorage:"remotestorage","http://tools.ietf.org/id/draft-dejong-remotestorage":"remotestorage",remoteStorage:"remotestorage","http://www.packetizer.com/rel/share":"share","http://webfinger.net/rel/profile-page":"profile",me:"profile",vcard:"vcard",blog:"blog","http://packetizer.com/rel/blog":"blog","http://schemas.google.com/g/2010#updates-from":"updates","https://camlistore.org/rel/server":"camilstore"},s={avatar:[],remotestorage:[],blog:[],vcard:[],updates:[],share:[],profile:[],webfist:[],camlistore:[]},i=["webfinger","host-meta","host-meta.json"];if(o.prototype.__fetchJRD=function(e,o,n){function s(){if(200===u.status)return a.__isValidJSON(u.responseText)?n(u.responseText):o(t({message:"invalid json",url:e,status:u.status}));if(404===u.status)return o(t({message:"endpoint unreachable",url:e,status:u.status}));if(u.status>=301&&u.status<=302){var s=u.getResponseHeader("Location");return r(s)?i(s):o(t({message:"no redirect URL found",url:e,status:u.status}))}return o(t({message:"error during request",url:e,status:u.status}))}function i(){u.onreadystatechange=function(){4===u.readyState&&s()},u.onload=function(e,t){s()},u.open("GET",e,!0),u.setRequestHeader("Accept","application/jrd+json, application/json"),u.send()}var a=this,u=new XMLHttpRequest;return i()},o.prototype.__isValidJSON=function(e){try{JSON.parse(e)}catch(t){return!1}return!0},o.prototype.__isLocalhost=function(e){var t=/^localhost(\.localdomain)?(\:[0-9]+)?$/;return t.test(e)},o.prototype.__processJRD=function(r,o,i,a){var u=JSON.parse(o);if("object"!=typeof u||"object"!=typeof u.links)return i("undefined"!=typeof u.error?t({message:u.error,request:r}):t({message:"unknown response from server",request:r}));var f=u.links,p={object:u,json:o,idx:{}};p.idx.properties={name:e},p.idx.links=JSON.parse(JSON.stringify(s)),f.map(function(e,t){if(n.hasOwnProperty(e.rel)&&p.idx.links[n[e.rel]]){var r={};Object.keys(e).map(function(t,o){r[t]=e[t]}),p.idx.links[n[e.rel]].push(r)}});var l=JSON.parse(o).properties;for(var c in l)l.hasOwnProperty(c)&&"http://packetizer.com/ns/name"===c&&(p.idx.properties.name=l[c]);return a(p)},o.prototype.lookup=function(e,t){function r(){var t="";return e.split("://")[1]||(t="acct:"),f+"://"+a+"/.well-known/"+i[u]+"?resource="+t+e}function o(e){if(s.config.uri_fallback&&"webfist.org"!==a&&u!==i.length-1)return u+=1,n();if(!s.config.tls_only&&"https"===f)return u=0,f="http",n();if(!s.config.webfist_fallback||"webfist.org"===a)return t(e);u=0,f="http",a="webfist.org";var o=r();s.__fetchJRD(o,t,function(e){s.__processJRD(o,e,t,function(e){"object"==typeof e.idx.links.webfist&&"string"==typeof e.idx.links.webfist[0].href&&s.__fetchJRD(e.idx.links.webfist[0].href,t,function(e){s.__processJRD(o,e,t,function(e){return t(null,t)})})})})}function n(){var e=r();s.__fetchJRD(e,o,function(r){s.__processJRD(e,r,t,function(e){t(null,e)})})}if("string"!=typeof e)throw new Error("first parameter must be a user address");if("function"!=typeof t)throw new Error("second parameter must be a callback");var s=this,a="";a=e.indexOf("://")>-1?e.replace(/ /g,"").split("://")[1]:e.replace(/ /g,"").split("@")[1];var u=0,f="https";return s.__isLocalhost(a)&&(f="http"),setTimeout(n,0)},o.prototype.lookupLink=function(e,t,r){return s.hasOwnProperty(t)?void this.lookup(e,function(e,o){var n=o.idx.links[t];return e?r(e):0===n.length?r('no links found with rel="'+t+'"'):r(null,n[0])}):r("unsupported rel "+t)},"object"==typeof window)window.WebFinger=o;else if("function"==typeof define&&define.amd)define([],function(){return o});else try{module.exports=o}catch(a){}}();