/* webfinger.js v2.6.4 | (c) 2012 Nick Jennings | License: AGPL | https://github.com/silverbucket/webfinger.js */
"undefined"==typeof XMLHttpRequest&&(XMLHttpRequest=require("xhr2")),function(t){function e(t){return t.toString=function(){return this.message},t}function r(t){return"string"==typeof t&&"https"===t.split("://")[0]}function o(t){"object"!=typeof t&&(t={}),this.config={tls_only:void 0===t.tls_only||t.tls_only,webfist_fallback:void 0!==t.webfist_fallback&&t.webfist_fallback,uri_fallback:void 0!==t.uri_fallback&&t.uri_fallback,request_timeout:void 0!==t.request_timeout?t.request_timeout:1e4}}var s={"http://webfist.org/spec/rel":"webfist","http://webfinger.net/rel/avatar":"avatar",remotestorage:"remotestorage","http://tools.ietf.org/id/draft-dejong-remotestorage":"remotestorage",remoteStorage:"remotestorage","http://www.packetizer.com/rel/share":"share","http://webfinger.net/rel/profile-page":"profile",me:"profile",vcard:"vcard",blog:"blog","http://packetizer.com/rel/blog":"blog","http://schemas.google.com/g/2010#updates-from":"updates","https://camlistore.org/rel/server":"camilstore"},n={avatar:[],remotestorage:[],blog:[],vcard:[],updates:[],share:[],profile:[],webfist:[],camlistore:[]},i=["webfinger","host-meta","host-meta.json"];o.prototype.__fetchJRD=function(t,o,s){function n(){if(!u){if(u=!0,200===f.status)return a.__isValidJSON(f.responseText)?s(f.responseText):o(e({message:"invalid json",url:t,status:f.status}));if(404===f.status)return o(e({message:"resource not found",url:t,status:f.status}));if(f.status>=301&&f.status<=302){var n=f.getResponseHeader("Location");return r(n)?i():o(e({message:"no redirect URL found",url:t,status:f.status}))}return o(e({message:"error during request",url:t,status:f.status}))}}function i(){f.onreadystatechange=function(){4===f.readyState&&n()},f.onload=function(){n()},f.ontimeout=function(){return o(e({message:"request timed out",url:t,status:f.status}))},f.open("GET",t,!0),f.setRequestHeader("Accept","application/jrd+json, application/json"),f.send()}var a=this,u=!1,f=new XMLHttpRequest;return f.timeout=this.config.request_timeout,i()},o.prototype.__isValidJSON=function(t){try{JSON.parse(t)}catch(t){return!1}return!0},o.prototype.__isLocalhost=function(t){return/^localhost(\.localdomain)?(\:[0-9]+)?$/.test(t)},o.prototype.__processJRD=function(t,r,o,i){var a=JSON.parse(r);if("object"!=typeof a||"object"!=typeof a.links)return o(void 0!==a.error?e({message:a.error,request:t}):e({message:"unknown response from server",request:t}));var u=a.links;Array.isArray(u)||(u=[]);var f={object:a,json:r,idx:{}};f.idx.properties={name:void 0},f.idx.links=JSON.parse(JSON.stringify(n)),u.map(function(t,e){if(s.hasOwnProperty(t.rel)&&f.idx.links[s[t.rel]]){var r={};Object.keys(t).map(function(e,o){r[e]=t[e]}),f.idx.links[s[t.rel]].push(r)}});var p=JSON.parse(r).properties;for(var l in p)p.hasOwnProperty(l)&&"http://packetizer.com/ns/name"===l&&(f.idx.properties.name=p[l]);return i(f)},o.prototype.lookup=function(t,e){function r(){var e="";return t.split("://")[1]||(e="acct:"),f+"://"+a+"/.well-known/"+i[u]+"?resource="+e+t}function o(t){if(n.config.uri_fallback&&"webfist.org"!==a&&u!==i.length-1)return u+=1,s();if(!n.config.tls_only&&"https"===f)return u=0,f="http",s();if(!n.config.webfist_fallback||"webfist.org"===a)return e(t);u=0,f="http",a="webfist.org";var o=r();n.__fetchJRD(o,e,function(t){n.__processJRD(o,t,e,function(t){"object"==typeof t.idx.links.webfist&&"string"==typeof t.idx.links.webfist[0].href&&n.__fetchJRD(t.idx.links.webfist[0].href,e,function(t){n.__processJRD(o,t,e,function(t){return e(null,e)})})})})}function s(){var t=r();n.__fetchJRD(t,o,function(r){n.__processJRD(t,r,e,function(t){e(null,t)})})}if("string"!=typeof t)throw new Error("first parameter must be a user address");if("function"!=typeof e)throw new Error("second parameter must be a callback");var n=this,a="";a=t.indexOf("://")>-1?t.replace(/ /g,"").split("/")[2]:t.replace(/ /g,"").split("@")[1];var u=0,f="https";return n.__isLocalhost(a)&&(f="http"),setTimeout(s,0)},o.prototype.lookupLink=function(t,e,r){if(!n.hasOwnProperty(e))return r("unsupported rel "+e);this.lookup(t,function(t,o){var s=o.idx.links[e];return t?r(t):0===s.length?r('no links found with rel="'+e+'"'):r(null,s[0])})},"function"==typeof define&&define.amd?define([],function(){return o}):"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=o),exports.WebFinger=o):t.WebFinger=o}(this);